<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    /* è‡ªå®šç¾©é¡è‰² */
    .btn-primary { background-color: #4F46E5; color: white; }
    .btn-standby-on { background-color: #F59E0B; color: white; border: 2px solid #F59E0B; }
    .btn-standby-off { background-color: #fff; color: #9CA3AF; border: 2px solid #E5E7EB; }
    .btn-disabled { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg relative">
  
  <div class="bg-blue-600 p-4 text-white text-center">
    <h1 class="text-xl font-bold">åˆè¨ºè³‡æ–™è¡¨</h1>
    <p class="text-sm opacity-80">ç‹æ­£æ–Œé†«å¸« å°å…’å¤–ç§‘</p>
  </div>

  <div v-if="loading" class="absolute inset-0 bg-white z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto mb-2"></div>
      <p class="text-gray-500">ç³»çµ±è®€å–ä¸­...</p>
    </div>
  </div>

  <div class="p-6 space-y-6">

    <section>
      <h3 class="text-lg font-bold text-gray-700 border-l-4 border-blue-500 pl-2 mb-3">åŸºæœ¬è³‡æ–™</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700">å°æœ‹å‹å§“å</label>
          <input v-model="form.name" type="text" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-300" placeholder="è«‹è¼¸å…¥å§“å">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">ç”Ÿæ—¥ (è¨ˆç®—å¹´é½¡ç”¨)</label>
          <input v-model="form.birthday" type="date" class="w-full border p-2 rounded">
          <p class="text-xs text-blue-500 mt-1" v-if="ageDisplay">ç›®å‰å¹´é½¡ï¼š{{ ageDisplay }}</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">ç›®å‰é«”é‡ (kg)</label>
          <input v-model.number="form.weight" type="number" step="0.1" class="w-full border p-2 rounded" placeholder="ä¾‹å¦‚: 15.5">
        </div>
      </div>
    </section>

    <section v-if="isBaby" class="bg-green-50 p-4 rounded-lg border border-green-200 animate-fade-in">
      <h3 class="text-md font-bold text-green-700 mb-2">ğŸ‘¶ å‡ºç”Ÿå² (ä¸€æ­²ä»¥ä¸‹å¿…å¡«)</h3>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-xs">å‡ºç”Ÿé€±æ•¸</label>
          <input v-model="form.birthWeeks" type="text" class="w-full border p-1 rounded" placeholder="ä¾‹å¦‚: 38é€±">
        </div>
        <div>
          <label class="text-xs">å‡ºç”Ÿé«”é‡ (g)</label>
          <input v-model.number="form.birthWeight" type="number" class="w-full border p-1 rounded" placeholder="ä¾‹å¦‚: 3200">
        </div>
      </div>
    </section>

    <section>
      <h3 class="text-lg font-bold text-gray-700 border-l-4 border-red-400 pl-2 mb-3">é¢¨éšªè©•ä¼°</h3>
      <div class="mb-4">
        <label class="block text-sm font-medium text-red-600">è¿‘æœŸå…©é€±æ˜¯å¦æœ‰æ„Ÿå†’ï¼Ÿ</label>
        <select v-model="form.coldStatus" class="w-full border p-2 rounded bg-red-50">
          <option value="ç„¡">ç„¡ï¼Œèº«é«”å¥åº·</option>
          <option value="æ„Ÿå†’ä¸­">æœ‰ï¼Œç›®å‰æ„Ÿå†’ä¸­ (æµé¼»æ°´/å’³å—½)</option>
          <option value="å·²ç—Šç™’">æœ‰ï¼Œä½†å·²ç—Šç™’</option>
        </select>
        <p v-if="form.coldStatus === 'æ„Ÿå†’ä¸­'" class="text-xs text-red-500 mt-1">âš ï¸ é†«å¸«å¯èƒ½éœ€è¦è©•ä¼°æ˜¯å¦å»¶å¾Œæ‰‹è¡“</p>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">ç‰¹æ®Šç—…å² (å¯è¤‡é¸)</label>
        <div class="flex flex-wrap gap-2 mt-2">
          <label v-for="item in historyOptions" :key="item" class="inline-flex items-center">
            <input type="checkbox" :value="item" v-model="form.history" class="mr-1">
            <span class="text-sm">{{ item }}</span>
          </label>
        </div>
      </div>

      <div v-if="isChild" class="bg-yellow-50 p-3 rounded border border-yellow-200 mb-4">
        <label class="block text-sm font-medium text-yellow-800">ğŸ¦· ç‰™é½’ç‹€æ³ (æ˜¯å¦æœ‰é¬†å‹•?)</label>
        <div class="mt-1 space-x-4">
          <label><input type="radio" value="ç„¡" v-model="form.teeth"> ç„¡é¬†å‹•</label>
          <label><input type="radio" value="æœ‰" v-model="form.teeth"> æœ‰é¬†å‹•</label>
        </div>
      </div>
    </section>

    <section>
      <h3 class="text-lg font-bold text-gray-700 border-l-4 border-purple-500 pl-2 mb-3">æ‰‹è¡“æ’ç¨‹</h3>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">é è¨ˆè¡“å¼</label>
        <select v-model="form.opType" class="w-full border p-2 rounded">
          <option disabled value="">è«‹é¸æ“‡</option>
          <option>è…¹è‚¡æºç–æ°£</option>
          <option>éš±çªç—‡</option>
          <option>å…¶ä»–</option>
        </select>
      </div>

      <div class="mb-6 p-3 bg-gray-50 rounded border border-gray-200">
        <label class="block text-sm font-medium text-gray-700 mb-2">é è¨ˆæ‰‹è¡“æ—¥æœŸ</label>
        
        <div class="flex items-center mb-3">
          <input type="checkbox" id="opDateUndecided" v-model="form.opDateUndecided" 
                 class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
          <label for="opDateUndecided" class="ml-2 text-sm text-gray-600">å°šæœªæ±ºå®š (æ™‚é–“å¦ç´„)</label>
        </div>

        <input v-model="form.opDate" 
               type="date" 
               class="w-full border p-2 rounded transition-colors disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed"
               :disabled="form.opDateUndecided">
      </div>
      <div class="p-4 rounded-xl border-2 cursor-pointer transition-all duration-200 text-center"
           :class="form.standby === 'Yes' ? 'btn-standby-on' : 'btn-standby-off'"
           @click="toggleStandby">
        <h4 class="font-bold text-lg">âš¡ é¡˜æ„å€™è£œè‡¨æ™‚ç©ºç¼ºå—ï¼Ÿ</h4>
        <p class="text-xs mt-1">{{ form.standby === 'Yes' ? 'âœ… æ˜¯çš„ï¼Œè‹¥æœ‰ç©ºæª”è«‹é€šçŸ¥æˆ‘ (å„ªå…ˆå®‰æ’)' : 'âŒ ä¸ç”¨ï¼Œæˆ‘ä¾åŸå®šè¨ˆç•«å°±å¥½' }}</p>
      </div>
    </section>

    <section>
      <div class="mb-4 mt-4">
        <label class="block text-sm font-medium text-gray-700">è—¥ç‰©åŠ‘å‹åå¥½</label>
        <select v-model="form.medType" class="w-full border p-2 rounded">
          <option>è—¥æ°´ (ç³–æ¼¿)</option>
          <option>è—¥ç²‰ (ç£¨ç²‰)</option>
          <option>è—¥ä¸¸ (åéŒ )</option>
        </select>
        <p v-if="form.weight > 30 && form.medType !== 'è—¥ä¸¸ (åéŒ )'" class="text-xs text-blue-500 mt-1">ğŸ’¡ é«”é‡ > 30kg å»ºè­°å˜—è©¦åè—¥ä¸¸ï¼Œæ•ˆæœè¼ƒç©©å®šå–”ï¼</p>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">è¨ºæ–·è­‰æ˜æ›¸éœ€æ±‚ (ä»½)</label>
        <input v-model.number="form.certCount" type="number" min="0" class="w-full border p-2 rounded">
      </div>
    </section>

    <button :class="['w-full btn-primary py-3 rounded-lg text-lg font-bold shadow-md active:scale-95 transition-transform mt-6', submitting ? 'btn-disabled' : '']"
            :disabled="submitting"
            @click="submitForm">
      {{ submitting ? 'é€å‡ºä¸­...' : 'ç¢ºèªé€å‡ºè³‡æ–™' }}
    </button>
    <p class="text-xs text-center text-gray-400 mt-2">é€å‡ºå¾Œå°‡ç”±é†«å¸«é€²è¡Œå¯©æ ¸</p>

  </div>
</div>

<script>
/* æ‚¨çš„ GAS ç¶²å€ */
const scriptURL = 'https://script.google.com/macros/s/AKfycbzFv6IVzOiTFBEx4h15viCbj1neAvIcx-pDZAFgIz24Bcg2NZrPh8-G1M51ek2Td4eI/exec';

const { createApp } = Vue;

createApp({
  data() {
    return {
      loading: true,
      submitting: false,
      form: {
        userId: '',
        name: '',
        birthday: '',
        weight: null,
        birthWeeks: '',
        birthWeight: null,
        allergy: 'ç„¡',
        history: [],
        teeth: 'ç„¡',
        coldStatus: 'ç„¡',
        opType: '',
        opDate: '', // æ–°å¢ï¼šæ‰‹è¡“æ—¥æœŸ
        opDateUndecided: false, // æ–°å¢ï¼šæ˜¯å¦æœªå®š
        standby: 'No',
        medType: 'è—¥æ°´ (ç³–æ¼¿)',
        certCount: 0
      },
      historyOptions: [
        'G6PD (è ¶è±†ç—‡)', 'å…ˆå¤©æ€§å¿ƒè‡Ÿç—…', 'å“®å–˜', 'æ—©ç”¢', 'å…ç–«ç¼ºé™·', 'ç™²ç™‡', 'å…¶ä»–'
      ]
    };
  },
  // ğŸ‘‡ ç›£è½å™¨ï¼šç•¶å‹¾é¸ã€Œå°šæœªæ±ºå®šã€æ™‚ï¼Œæ¸…ç©ºæ—¥æœŸ
  watch: {
    'form.opDateUndecided'(newVal) {
      if (newVal) {
        this.form.opDate = '';
      }
    }
  },
  computed: {
    ageDisplay() {
      if (!this.form.birthday) return '';
      const bd = new Date(this.form.birthday);
      if (isNaN(bd)) return '';
      const now = new Date();
      let years = now.getFullYear() - bd.getFullYear();
      let months = now.getMonth() - bd.getMonth();
      let days = now.getDate() - bd.getDate();
      if (days < 0) months -= 1;
      if (months < 0) { years -= 1; months += 12; }
      if (years < 1) {
        const totalMonths = (now.getFullYear() - bd.getFullYear()) * 12 + (now.getMonth() - bd.getMonth());
        return totalMonths + ' å€‹æœˆ';
      }
      return years + ' æ­²' + (months > 0 ? (' ' + months + ' å€‹æœˆ') : '');
    },
    isBaby() {
      if (!this.form.birthday) return false;
      const bd = new Date(this.form.birthday);
      const now = new Date();
      const diffMonths = (now - bd) / (1000 * 60 * 60 * 24 * 30.4375);
      return diffMonths < 12;
    },
    isChild() {
      if (!this.form.birthday) return false;
      const bd = new Date(this.form.birthday);
      const now = new Date();
      let years = now.getFullYear() - bd.getFullYear();
      const m = now.getMonth() - bd.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < bd.getDate())) years -= 1;
      return years >= 1 && years < 18;
    }
  },
  methods: {
    toggleStandby() {
      this.form.standby = this.form.standby === 'Yes' ? 'No' : 'Yes';
    },
    async submitForm() {
      if (!this.form.name) { alert('è«‹è¼¸å…¥å°æœ‹å‹å§“å'); return; }
      if (!this.form.opType) { alert('è«‹é¸æ“‡é è¨ˆè¡“å¼'); return; }
      if (this.isBaby && (!this.form.birthWeeks || !this.form.birthWeight)) {
        alert('ä¸€æ­²ä»¥ä¸‹è«‹å¡«å¯«å‡ºç”Ÿé€±æ•¸èˆ‡å‡ºç”Ÿé«”é‡'); return;
      }
      
      // é©—è­‰ï¼šå¦‚æœæ²’æœ‰å‹¾é¸æœªå®šï¼Œä¸”æ²’å¡«æ—¥æœŸ (æ­¤ç‚ºé¸å¡«ï¼Œè‹¥æ‚¨å¸Œæœ›å¿…å¡«è«‹å–æ¶ˆè¨»è§£)
      // if (!this.form.opDateUndecided && !this.form.opDate) {
      //   alert('è«‹é¸æ“‡é è¨ˆæ‰‹è¡“æ—¥æœŸï¼Œæˆ–å‹¾é¸ã€Œå°šæœªæ±ºå®šã€'); return;
      // }

      this.submitting = true;

      try {
        const fd = new FormData();
        fd.append('userId', this.form.userId || '');
        fd.append('name', this.form.name || '');
        fd.append('birthday', this.form.birthday || '');
        fd.append('weight', this.form.weight != null ? String(this.form.weight) : '');
        fd.append('birthWeeks', this.form.birthWeeks || '');
        fd.append('birthWeight', this.form.birthWeight != null ? String(this.form.birthWeight) : '');
        fd.append('allergy', this.form.allergy || '');
        fd.append('teeth', this.form.teeth || '');
        fd.append('coldStatus', this.form.coldStatus || '');
        fd.append('opType', this.form.opType || '');
        
        // ğŸ‘‡ æ–°å¢ï¼šå‚³é€æ‰‹è¡“æ—¥æœŸ (å¦‚æœå‹¾é¸æœªå®šï¼Œå‰‡å‚³é€ç©ºå­—ä¸²)
        fd.append('opDate', this.form.opDateUndecided ? '' : (this.form.opDate || ''));

        fd.append('standby', this.form.standby || 'No');
        fd.append('medType', this.form.medType || '');
        fd.append('certCount', String(this.form.certCount || 0));

        if (Array.isArray(this.form.history)) {
          this.form.history.forEach(item => fd.append('history', item));
        }

        const res = await fetch(scriptURL, {
          method: 'POST',
          body: fd,
        });

        if (res.ok) {
          alert('é€å‡ºæˆåŠŸï¼Œæ„Ÿè¬ï¼');
          // ğŸ‘‡ ä¿®æ”¹ï¼šé€å‡ºæˆåŠŸå¾Œé—œé–‰è¦–çª—
          if (liff.isInClient()) {
            liff.closeWindow();
          }
        } else {
          alert('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      } catch (err) {
        console.error('æäº¤ç™¼ç”ŸéŒ¯èª¤:', err);
        alert('é€å‡ºç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
      } finally {
        this.submitting = false;
      }
    },
  },
  async mounted() {
    try {
      if (window.liff) {
        // è«‹ç¢ºèªæ‚¨çš„ LIFF ID
        await liff.init({ liffId: '2009045600-eq6cC2k6' }); 
        if (liff.isLoggedIn && liff.isLoggedIn()) {
          try {
            const profile = await liff.getProfile();
            this.form.userId = profile.userId || '';
          } catch (err) { }
        }
      }
    } catch (err) {
      console.warn('LIFF init failed:', err);
    } finally {
      this.loading = false;
    }
  }
}).mount('#app');
</script>

</body>
</html>
