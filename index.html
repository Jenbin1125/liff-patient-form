<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    /* è‡ªå®šç¾©é¡è‰² */
    .btn-primary { background-color: #4F46E5; color: white; }
    .btn-standby-on { background-color: #F59E0B; color: white; border: 2px solid #F59E0B; } /* äº®æ©˜è‰²ä»£è¡¨é¡˜æ„ */
    .btn-standby-off { background-color: #fff; color: #9CA3AF; border: 2px solid #E5E7EB; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg relative">
  
  <div class="bg-blue-600 p-4 text-white text-center">
    <h1 class="text-xl font-bold">åˆè¨ºè³‡æ–™è¡¨ 2.0</h1>
    <p class="text-sm opacity-80">ç‹æ­£æ–Œé†«å¸« å°å…’å¤–ç§‘</p>
  </div>

  <div v-if="loading" class="absolute inset-0 bg-white z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto mb-2"></div>
      <p class="text-gray-500">ç³»çµ±è®€å–ä¸­...</p>
    </div>
  </div>

  <div class="p-6 space-y-6">

    <section>
      <h3 class="text-lg font-bold text-gray-700 border-l-4 border-blue-500 pl-2 mb-3">åŸºæœ¬è³‡æ–™</h3>
      
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700">å°æœ‹å‹å§“å</label>
          <input v-model="form.name" type="text" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-300" placeholder="è«‹è¼¸å…¥å§“å">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">ç”Ÿæ—¥ (è¨ˆç®—å¹´é½¡ç”¨)</label>
          <input v-model="form.birthday" type="date" class="w-full border p-2 rounded">
          <p class="text-xs text-blue-500 mt-1" v-if="ageDisplay">ç›®å‰å¹´é½¡ï¼š{{ ageDisplay }}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">ç›®å‰é«”é‡ (kg)</label>
          <input v-model="form.weight" type="number" step="0.1" class="w-full border p-2 rounded" placeholder="ä¾‹å¦‚: 15.5">
        </div>
      </div>
    </section>

    <section v-if="isBaby" class="bg-green-50 p-4 rounded-lg border border-green-200 animate-fade-in">
      <h3 class="text-md font-bold text-green-700 mb-2">ğŸ‘¶ å‡ºç”Ÿå² (ä¸€æ­²ä»¥ä¸‹å¿…å¡«)</h3>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-xs">å‡ºç”Ÿé€±æ•¸</label>
          <input v-model="form.birthWeeks" type="text" class="w-full border p-1 rounded" placeholder="ä¾‹å¦‚: 38é€±">
        </div>
        <div>
          <label class="text-xs">å‡ºç”Ÿé«”é‡ (g)</label>
          <input v-model="form.birthWeight" type="number" class="w-full border p-1 rounded" placeholder="ä¾‹å¦‚: 3200">
        </div>
      </div>
    </section>

    <section>
      <h3 class="text-lg font-bold text-gray-700 border-l-4 border-red-400 pl-2 mb-3">é¢¨éšªè©•ä¼°</h3>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-red-600">è¿‘æœŸå…©é€±æ˜¯å¦æœ‰æ„Ÿå†’ï¼Ÿ</label>
        <select v-model="form.coldStatus" class="w-full border p-2 rounded bg-red-50">
          <option value="ç„¡">ç„¡ï¼Œèº«é«”å¥åº·</option>
          <option value="æ„Ÿå†’ä¸­">æœ‰ï¼Œç›®å‰æ„Ÿå†’ä¸­ (æµé¼»æ°´/å’³å—½)</option>
          <option value="å·²ç—Šç™’">æœ‰ï¼Œä½†å·²ç—Šç™’</option>
        </select>
        <p v-if="form.coldStatus === 'æ„Ÿå†’ä¸­'" class="text-xs text-red-500 mt-1">âš ï¸ é†«å¸«å¯èƒ½éœ€è¦è©•ä¼°æ˜¯å¦å»¶å¾Œæ‰‹è¡“</p>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">ç‰¹æ®Šç—…å² (å¯è¤‡é¸)</label>
        <div class="flex flex-wrap gap-2 mt-2">
          <label v-for="item in historyOptions" :key="item" class="inline-flex items-center">
            <input type="checkbox" :value="item" v-model="form.history" class="mr-1">
            <span class="text-sm">{{ item }}</span>
          </label>
        </div>
      </div>

      <div v-if="isChild" class="bg-yellow-50 p-3 rounded border border-yellow-200 mb-4">
        <label class="block text-sm font-medium text-yellow-800">ğŸ¦· ç‰™é½’ç‹€æ³ (æ˜¯å¦æœ‰é¬†å‹•?)</label>
        <div class="mt-1 space-x-4">
          <label><input type="radio" value="ç„¡" v-model="form.teeth"> ç„¡é¬†å‹•</label>
          <label><input type="radio" value="æœ‰" v-model="form.teeth"> æœ‰é¬†å‹•</label>
        </div>
      </div>
    </section>

    <section>
      <h3 class="text-lg font-bold text-gray-700 border-l-4 border-purple-500 pl-2 mb-3">æ‰‹è¡“æ’ç¨‹</h3>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">é è¨ˆè¡“å¼</label>
        <select v-model="form.opType" class="w-full border p-2 rounded">
          <option disabled value="">è«‹é¸æ“‡</option>
          <option>è…¹è‚¡æºç–æ°£</option>
          <option>éš±çªç—‡</option>
          <option>å…¶ä»–</option>
        </select>
      </div>

      <div class="p-4 rounded-xl border-2 cursor-pointer transition-all duration-200 text-center"
           :class="form.standby === 'Yes' ? 'btn-standby-on' : 'btn-standby-off'"
           @click="toggleStandby">
        <h4 class="font-bold text-lg">âš¡ é¡˜æ„å€™è£œè‡¨æ™‚ç©ºç¼ºå—ï¼Ÿ</h4>
        <p class="text-xs mt-1">{{ form.standby === 'Yes' ? 'âœ… æ˜¯çš„ï¼Œè‹¥æœ‰ç©ºæª”è«‹é€šçŸ¥æˆ‘ (å„ªå…ˆå®‰æ’)' : 'âŒ ä¸ç”¨ï¼Œæˆ‘ä¾åŸå®šè¨ˆç•«å°±å¥½' }}</p>
      </div>
    </section>

    <section>
      <div class="mb-4 mt-4">
        <label class="block text-sm font-medium text-gray-700">è—¥ç‰©åŠ‘å‹åå¥½</label>
        <select v-model="form.medType" class="w-full border p-2 rounded">
          <option>è—¥æ°´ (ç³–æ¼¿)</option>
          <option>è—¥ç²‰ (ç£¨ç²‰)</option>
          <option>è—¥ä¸¸ (åéŒ )</option>
        </select>
        <p v-if="form.weight > 30 && form.medType !== 'è—¥ä¸¸ (åéŒ )'" class="text-xs text-blue-500 mt-1">ğŸ’¡ é«”é‡ > 30kg å»ºè­°å˜—è©¦åè—¥ä¸¸ï¼Œæ•ˆæœè¼ƒç©©å®šå–”ï¼</p>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">è¨ºæ–·è­‰æ˜æ›¸éœ€æ±‚ (ä»½)</label>
        <input v-model="form.certCount" type="number" min="0" class="w-full border p-2 rounded">
      </div>
    </section>

    <button @click="submitForm" class="w-full btn-primary py-3 rounded-lg text-lg font-bold shadow-md active:scale-95 transition-transform mt-6">
      ç¢ºèªé€å‡ºè³‡æ–™
    </button>
    <p class="text-xs text-center text-gray-400 mt-2">é€å‡ºå¾Œå°‡ç”±é†«å¸«åŠ©ç†é€²è¡Œå¯©æ ¸</p>

  </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      loading: true,
      form: {
        userId: '', // è‡ªå‹•æŠ“å–
        name: '',
        birthday: '',
        weight: '',
        birthWeeks: '',
        birthWeight: '',
        allergy: 'ç„¡',
        history: [],
        teeth: 'ç„¡',
        coldStatus: 'ç„¡',
        opType: '',
        standby: 'No', // é è¨­ä¸å€™è£œ
        medType: 'è—¥æ°´ (ç³–æ¼¿)',
        certCount: 0
      },
      historyOptions: ['G6PD (è ¶è±†ç—‡)', 'æ°£å–˜', 'å¿ƒè‡Ÿç—…', 'ç™²ç™‡', 'éæ•é«”è³ª']
    }
  },
  computed: {
    // è‡ªå‹•è¨ˆç®—å¹´é½¡ (æ­²)
    age() {
      if (!this.form.birthday) return -1;
      const birthDate = new Date(this.form.birthday);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age;
    },
    // é¡¯ç¤ºç”¨çš„å¹´é½¡å­—ä¸²
    ageDisplay() {
      if (this.age < 0) return '';
      return this.age + " æ­²";
    },
    // é‚è¼¯åˆ¤æ–·ï¼šæ˜¯å¦ç‚ºå¬°å…’ (<1æ­²)
    isBaby() {
      return this.age >= 0 && this.age < 1;
    },
    // é‚è¼¯åˆ¤æ–·ï¼šæ˜¯å¦ç‚ºå…’ç«¥ (>4æ­²ï¼Œæ›ç‰™æœŸ)
    isChild() {
      return this.age >= 4;
    }
  },
  methods: {
    toggleStandby() {
      this.form.standby = (this.form.standby === 'Yes') ? 'No' : 'Yes';
    },
async submitForm() {
      if(!this.form.name || !this.form.weight) {
        alert("è«‹è‡³å°‘å¡«å¯«å§“åèˆ‡é«”é‡å–”ï¼");
        return;
      }
      
      this.loading = true; // é–‹å§‹è½‰åœˆåœˆ
      
      try {
        // æ‚¨çš„ GAS ç¶²å€
        const scriptURL = 'https://script.google.com/macros/s/æ‚¨çš„ID/exec'; 
        
        // ğŸ‘‡ é—œéµä¿®æ”¹ï¼šåŠ ä¸Š mode: 'no-cors'
        await fetch(scriptURL, {
          method: 'POST',
          body: JSON.stringify(this.form),
          mode: 'no-cors',  // <--- é€™ä¸€è¡Œæ˜¯æ•‘æ˜Ÿï¼
          headers: { 'Content-Type': 'text/plain' }
        });
        
        // å› ç‚º no-cors æ¨¡å¼è®€ä¸åˆ°å›å‚³çµæœï¼Œåªè¦æ²’å ±éŒ¯æˆ‘å€‘å°±è¦–ç‚ºæˆåŠŸ
        alert("è³‡æ–™é€å‡ºæˆåŠŸï¼");
        this.loading = false;
        liff.closeWindow(); // é—œé–‰è¦–çª—
        
      } catch (error) {
        // è¬ä¸€çœŸçš„å¤±æ•—ï¼ŒæŠŠè½‰åœˆåœˆé—œæ‰ï¼Œé¡¯ç¤ºéŒ¯èª¤
        this.loading = false;
        alert("å‚³é€å¤±æ•—ï¼Œè«‹æˆªåœ–çµ¦é†«å¸«ï¼š" + error);
      }
    }
      
      this.loading = true;
      
      // å‘¼å« Google Apps Script (AJAX Request)
      // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ fetch éœ€è¦è™•ç† CORSï¼Œä½†å› ç‚ºæ˜¯åœ¨ LIFF ä¸­ï¼Œå»ºè­°ç”¨ POST å‚³é€ JSON
      try {
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzhFTJVgo7ssQoAJFnrKLQ1ylHOECeilbdxUtdL9j7ROp4Ki25Q9Bgg6-M2ugd1LEE6/exec'; // ğŸ”´ éƒ¨ç½²å¾Œå¡«å…¥é€™è£¡
        
        await fetch(scriptURL, {
          method: 'POST',
          body: JSON.stringify(this.form),
          headers: { 'Content-Type': 'text/plain;charset=utf-8' } // é¿é–‹ CORS é æª¢
        });
        
        alert("è³‡æ–™é€å‡ºæˆåŠŸï¼");
        liff.closeWindow(); // é—œé–‰è¦–çª—
        
      } catch (error) {
        alert("å‚³é€å¤±æ•—ï¼š" + error);
        this.loading = false;
      }
    }
  },
  async mounted() {
    // åˆå§‹åŒ– LIFF
    const LIFF_ID = '2009045600-eq6cC2k6'; // ğŸ”´ è«‹å¡«å…¥æ‚¨çš„ LIFF ID
    
    try {
      await liff.init({ liffId: LIFF_ID });
      if (liff.isLoggedIn()) {
        const profile = await liff.getProfile();
        this.form.userId = profile.userId;
        // é€™è£¡å¯ä»¥åšã€Œè®€å–èˆŠè³‡æ–™ã€çš„é‚è¼¯ (é€²éš)
      } else {
        liff.login();
      }
    } catch (err) {
      console.error(err);
    } finally {
      this.loading = false;
    }
  }
}).mount('#app');
</script>

</body>
</html>
